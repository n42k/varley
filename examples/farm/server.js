const varley = require('varley')(this)
varley.module('chat')

varley.on('start', () => {
  varley.pub.world = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1],
    [1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1],
    [1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1],
    [1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1],
    [1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1],
    [1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1],
    [1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1],
    [1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1],
    [1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1],
    [1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1],
    [1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1],
    [1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1],
    [1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1],
    [1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1],
    [1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1],
    [1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1,1,1,1,6,1,1,1,1],
    [1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1],
    [1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1],
    [1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1,6,6,6,6,6,6,6,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
  ]
})

function till(varley, player) {
  let tileX = Math.round(player.x/32)
  let tileY = Math.round(player.y/32)

  if(tileY < 0 || tileY >= varley.pub.world.length ||
     tileX < 0 || tileX >= varley.pub.world[tileY].length ||
     varley.pub.world[tileY][tileX] !== 6)
     return

  // https://opengameart.org/content/jump-landing-sound
  varley.playSound('farm.wav')

  varley.pub.world[tileY][tileX] = 15
}

varley.on('connect', player => {
  player
    .Interactible(farmer, 384, 384)
    .Movement()
    .Collision(varley.pub.world, farm, [
      S, S, S, A, S, A, A, A, A,
      S, S, S, A, S, A, A, A, A
    ])
    .TopDown()
    .Animations(2, [2, 1, 3, 0])
    .Touchable(varley.players)

  player.on('touch', (player, other) => till(varley, player))
})

varley.on('press', (player, key) => {
  if(key !== 'SPACE')
    return

  till(varley, player)
})

varley.run({tickRate: 16})
